# AI-RSS-Hub 项目说明文档

> **文档日期**: 2025-12-25
> **项目版本**: 1.0.0
> **文档用途**: 项目评价与优化建议

---

## 一、项目概述

### 1.1 项目定位

**AI-RSS-Hub** 是一个基于 FastAPI 构建的智能 RSS 聚合系统，通过 AI 自动为文章生成摘要，帮助用户高效获取信息。

### 1.2 核心功能

| 功能 | 描述 |
|------|------|
| RSS 抓取 | 自动抓取配置的 RSS 源，支持定时任务 |
| AI 摘要 | 使用 LLM API 自动生成文章摘要（100字以内） |
| 数据持久化 | 使用 SQLite 存储 Feed 和 Article 数据 |
| RESTful API | 提供完整的 API 接口用于管理和查询 |
| 安全防护 | API Token 认证、速率限制、输入验证、SSRF 防护 |

### 1.3 使用场景

- 个人/团队信息聚合
- 技术资讯自动收集
- AI 辅助阅读摘要
- 多源 RSS 统一管理

---

## 二、技术架构

### 2.1 技术栈

| 层级 | 技术 | 版本 | 用途 |
|------|------|------|------|
| Web 框架 | FastAPI | 0.115.5 | 高性能异步 Web 框架 |
| ORM | SQLModel | 0.0.22 | 基于 Pydantic 的 ORM |
| 数据库 | SQLite | - | 轻量级关系数据库 |
| RSS 解析 | feedparser | 6.0.11 | RSS/Atom 格式解析 |
| AI 客户端 | OpenAI SDK | 1.58.1 | LLM API 调用（支持兼容接口） |
| 任务调度 | APScheduler | 3.10.4 | 定时任务管理 |
| HTTP 客户端 | httpx | 0.27.2 | 异步 HTTP 请求 |
| 配置管理 | pydantic-settings | 2.6.1 | 环境变量配置 |

### 2.2 安全组件

| 组件 | 技术 | 用途 |
|------|------|------|
| 认证 | API Token (Header) | 管理操作认证 |
| 速率限制 | slowapi | 60次/分钟 |
| 输入验证 | Pydantic + 正则 | URL/SSRF/XSS 防护 |
| 日志安全 | 自定义 Filter | 敏感信息脱敏 |
| 安全响应头 | 自定义 Middleware | HSTS/CSP/X-Frame-Options |

### 2.3 项目结构

```
AI-RSS-Hub/
├── app/
│   ├── __init__.py
│   ├── main.py              # FastAPI 应用入口
│   ├── config.py            # 配置管理（包含安全配置）
│   ├── models.py            # SQLModel 数据模型
│   ├── database.py          # 数据库连接和会话管理
│   ├── crud.py              # CRUD 操作实现
│   ├── scheduler.py         # 定时任务配置
│   ├── api/
│   │   ├── __init__.py
│   │   └── routes.py        # RESTful API 路由
│   ├── services/
│   │   ├── __init__.py
│   │   ├── rss_fetcher.py   # RSS 抓取服务
│   │   └── summarizer.py    # AI 摘要生成服务
│   └── security/            # 安全模块（新增）
│       ├── __init__.py
│       ├── auth.py          # API Token 认证
│       ├── validators.py    # 输入验证（URL/SSRF/XSS）
│       ├── logger.py        # 日志脱敏
│       ├── middleware.py    # 安全响应头
│       └── rate_limiter.py  # 速率限制
├── tests/
│   ├── __init__.py
│   └── test_security.py     # 安全功能测试
├── scripts/
│   ├── generate_token.py    # Token 生成工具
│   └── check_security.sh    # 依赖安全检查脚本
├── requirements.txt         # 依赖列表
├── .env                     # 环境变量（不提交）
├── .env.example             # 环境变量示例
├── .env.security            # 安全配置示例（新增）
├── .gitignore
├── README.md
└── ai_rss_hub.db           # SQLite 数据库文件
```

---

## 三、数据模型

### 3.1 Feed 模型（RSS 源）

```python
class Feed(SQLModel, table=True):
    id: Optional[int]          # 主键
    name: str                  # RSS 源名称（索引）
    url: str                   # RSS 源 URL（唯一索引）
    category: str              # 分类（默认 "tech"）
    is_active: bool            # 是否启用（默认 True）
    created_at: datetime       # 创建时间
    updated_at: datetime       # 更新时间
    articles: List[Article]    # 关联文章（一对多）
```

### 3.2 Article 模型（文章）

```python
class Article(SQLModel, table=True):
    id: Optional[int]          # 主键
    title: str                 # 文章标题（索引）
    link: str                  # 文章链接（唯一索引）
    content: Optional[str]     # 原始内容
    summary: Optional[str]     # AI 生成的摘要
    published_at: Optional[datetime]  # 发布时间（索引）
    feed_id: int               # 所属 RSS 源 ID（外键）
    created_at: datetime       # 创建时间
    feed: Optional[Feed]       # 关联的 Feed（多对一）
```

---

## 四、核心功能实现

### 4.1 RSS 抓取流程

**文件**: `app/services/rss_fetcher.py`

```python
def fetch_all_feeds(session: Session) -> dict:
    """
    抓取所有活跃的 RSS 源
    流程：
    1. 获取所有 is_active=True 的 Feed
    2. 使用 feedparser 解析 RSS
    3. 提取文章信息（标题、链接、内容、发布时间）
    4. 基于链接去重（link 唯一索引）
    5. 调用 AI 生成摘要（异步但串行处理）
    6. 保存到数据库
    """
```

**已知问题**: AI 摘要是串行生成的，影响抓取性能。

### 4.2 AI 摘要生成

**文件**: `app/services/summarizer.py`

```python
def summarize_text(text: str) -> str:
    """
    使用 OpenAI 兼容 API 生成摘要
    - 支持自定义 base_url（OpenAI/DeepSeek/Gemini）
    - 限制输入长度为 2000 字符
    - 限制输出长度为 100 字符
    - 超时时间 30 秒
    """
```

**提示词**:
```
请用中文对以下文章内容进行简短总结，不超过100字：

[文章内容前2000字]

请直接输出总结内容，不要添加其他说明。
```

### 4.3 定时任务

**文件**: `app/scheduler.py`

- 使用 APScheduler 的 BackgroundScheduler
- 默认间隔：1 小时（可通过 `FETCH_INTERVAL_HOURS` 配置）
- 非阻塞执行，不影响 Web 服务
- 应用启动时自动启动，关闭时自动停止

---

## 五、API 接口

### 5.1 公开端点（无需认证）

| 方法 | 端点 | 功能 | 示例 |
|------|------|------|------|
| GET | `/api/health` | 健康检查 | `curl /api/health` |
| GET | `/api/status` | 系统状态 | `curl /api/status` |
| GET | `/api/feeds` | 获取 RSS 源列表 | `curl /api/feeds?active_only=true` |
| GET | `/api/articles` | 获取文章列表 | `curl /api/articles?limit=50&days=7` |

### 5.2 保护端点（需要认证）

| 方法 | 端点 | 功能 | 认证方式 |
|------|------|------|----------|
| POST | `/api/feeds` | 添加 RSS 源 | `X-API-Token` 请求头 |
| POST | `/api/feeds/fetch` | 手动触发抓取 | `X-API-Token` 请求头 |

### 5.3 认证方式

```bash
# 设置环境变量 API_TOKEN 后，需要在请求头中携带：
curl -X POST http://localhost:8000/api/feeds \
  -H "X-API-Token: your-token-here" \
  -H "Content-Type: application/json" \
  -d '{"name":"Feed","url":"https://example.com/rss"}'
```

---

## 六、安全配置

### 6.1 认证机制

**类型**: API Token (Bearer Token in Header)

```python
# app/security/auth.py
async def verify_api_token(token: str = Security(api_key_header)) -> bool:
    """
    从 X-API-Token 请求头获取 Token
    与环境变量 API_TOKEN 比较
    未配置时跳过认证（开发模式）
    """
```

### 6.2 输入验证

**文件**: `app/security/validators.py`

| 验证项 | 规则 | 防护目标 |
|--------|------|----------|
| URL 格式 | 必须是 HTTP/HTTPS | 防止无效输入 |
| URL 长度 | 最大 2048 字符 | 防止缓冲区溢出 |
| 内网地址 | 拒绝 localhost/127.0.0.1/192.168.x/10.x | SSRF 防护 |
| 名称长度 | 最大 200 字符 | 防止 DoS |
| 分类长度 | 最大 50 字符 | 防止 DoS |
| HTML 转义 | 自动转义特殊字符 | XSS 防护 |

### 6.3 速率限制

```python
# 默认配置
RATE_LIMIT_ENABLED=true
RATE_LIMIT_TIMES=60      # 60 次
RATE_LIMIT_SECONDS=60    # 每分钟
```

### 6.4 CORS 配置

```python
# 从环境变量读取允许的域名
CORS_ORIGINS=http://localhost:3000,https://yourdomain.com

# 未配置时默认：
# - http://localhost:3000
# - http://localhost:8000
```

### 6.5 安全响应头

```http
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000; includeSubDomains
Content-Security-Policy: default-src 'self'
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: geolocation=(), microphone=(), camera=()
```

### 6.6 日志安全

- 自动过滤敏感字段：`api_key`, `token`, `password`, `secret`
- 日志输出格式：`***REDACTED***`

---

## 七、配置说明

### 7.1 环境变量

| 变量 | 必填 | 默认值 | 说明 |
|------|------|--------|------|
| `OPENAI_API_KEY` | ✅ | - | LLM API 密钥 |
| `OPENAI_API_BASE` | ❌ | https://api.openai.com/v1 | API 地址 |
| `OPENAI_MODEL` | ❌ | gpt-3.5-turbo | 模型名称 |
| `DATABASE_URL` | ❌ | sqlite:///./ai_rss_hub.db | 数据库连接 |
| `FETCH_INTERVAL_HOURS` | ❌ | 1 | 抓取间隔（小时） |
| `SUMMARY_MAX_LENGTH` | ❌ | 100 | 摘要最大长度 |

#### 安全配置（新增）

| 变量 | 必填 | 默认值 | 说明 |
|------|------|--------|------|
| `API_TOKEN` | ❌ | None | 管理 API Token |
| `CORS_ORIGINS` | ❌ | "" | 允许的跨域源（逗号分隔） |
| `RATE_LIMIT_ENABLED` | ❌ | true | 是否启用速率限制 |
| `RATE_LIMIT_TIMES` | ❌ | 60 | 速率限制次数 |
| `RATE_LIMIT_SECONDS` | ❌ | 60 | 速率限制窗口 |
| `MAX_URL_LENGTH` | ❌ | 2048 | URL 最大长度 |
| `MAX_NAME_LENGTH` | ❌ | 200 | 名称最大长度 |
| `MAX_CATEGORY_LENGTH` | ❌ | 50 | 分类最大长度 |

### 7.2 配置文件

- `.env` - 实际配置（不提交到 Git）
- `.env.example` - 基础配置示例
- `.env.security` - 安全配置示例

---

## 八、依赖清单

### 8.1 核心依赖

```txt
fastapi==0.115.5
uvicorn[standard]==0.34.0
sqlmodel==0.0.22
sqlalchemy==2.0.36
feedparser==6.0.11
openai==1.58.1
apscheduler==3.10.4
pydantic-settings==2.6.1
python-dotenv==1.0.1
httpx==0.27.2
```

### 8.2 安全依赖

```txt
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
slowapi==0.1.9
safety==3.2.0
bandit==1.7.6
```

### 8.3 开发依赖

```txt
pytest==8.3.4
pytest-asyncio==0.24.0
```

---

## 九、已知问题和局限性

### 9.1 性能问题

| 问题 | 影响 | 建议 |
|------|------|------|
| AI 摘要串行处理 | 抓取速度慢 | 使用 asyncio 并发处理 |
| 无缓存机制 | 重复请求 | 添加 Redis 缓存 |
| SQLite 单实例 | 并发受限 | 生产环境使用 PostgreSQL |

### 9.2 功能缺陷

| 问题 | 影响 | 建议 |
|------|------|------|
| 无用户系统 | 仅单 Token | 添加多用户支持 |
| 无分页功能 | 大数据量性能差 | 实现完整的分页 |
| 无全文搜索 | 查询受限 | 使用 SQLite FTS5 |
| 无 RSS 导出 | 功能不完整 | 添加摘要 RSS 输出 |

### 9.3 安全问题

| 问题 | 风险等级 | 建议 |
|------|----------|------|
| Token 无过期机制 | 中 | 添加 Token 过期时间 |
| 无审计日志 | 中 | 记录管理操作 |
| 无 IP 白名单 | 低 | 限制 Token 使用 IP |
| CORS 配置可能不当 | 高 | 生产环境严格配置 |

---

## 十、当前状态

### 10.1 开发状态

- **版本**: 1.0.0
- **最后更新**: 2025-12-25
- **状态**: 功能完整，已添加安全配置

### 10.2 最新更新

1. ✅ 添加 API Token 认证机制
2. ✅ 添加输入验证（URL/SSRF/XSS）
3. ✅ 添加速率限制
4. ✅ 添加日志脱敏
5. ✅ 添加安全响应头
6. ✅ 添加依赖安全检查脚本

### 10.3 测试状态

| 测试类型 | 状态 | 覆盖率 |
|----------|------|--------|
| 安全功能测试 | ✅ 通过 | 基础 |
| 单元测试 | ❌ 未实现 | 0% |
| 集成测试 | ❌ 未实现 | 0% |
| 压力测试 | ❌ 未实现 | 0% |

---

## 十一、运行方式

### 11.1 快速启动

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 文件，添加 OPENAI_API_KEY

# 3. 运行应用
python -m app.main

# 或使用 uvicorn
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 11.2 访问地址

- API 文档: http://localhost:8000/docs
- 系统状态: http://localhost:8000/api/status
- 健康检查: http://localhost:8000/api/health

---

## 十二、默认数据

系统启动时自动初始化 3 个科技类 RSS 源：

1. **Hacker News** - https://hnrss.org/frontpage
2. **TechCrunch** - https://techcrunch.com/feed/
3. **Ars Technica** - https://feeds.arstechnica.com/arstechnica/index

---

## 十三、评价建议方向

### 13.1 架构设计

- 目录结构是否合理？
- 模块划分是否清晰？
- 是否有过度设计或设计不足？

### 13.2 代码质量

- Python 代码风格是否规范？
- 类型注解是否完整？
- 错误处理是否充分？
- 日志记录是否合理？

### 13.3 安全性

- 认证机制是否可靠？
- 输入验证是否完整？
- 是否存在安全漏洞？
- 安全配置是否合理？

### 13.4 性能优化

- 数据库查询是否高效？
- 是否有性能瓶颈？
- 缓存策略是否合理？
- 并发处理是否优化？

### 13.5 可维护性

- 代码是否易于理解？
- 文档是否完整？
- 测试覆盖率如何？
- 依赖管理是否合理？

### 13.6 功能建议

- 缺少哪些关键功能？
- 哪些功能可以改进？
- 是否有更好的实现方式？
- 是否有不必要的复杂性？

---

## 十四、附录

### 14.1 相关文档

- `README.md` - 项目说明
- `SETUP.md` - 环境搭建
- `PROJECT_UNDERSTANDING.md` - 项目理解文档

### 14.2 外部资源

- FastAPI 文档: https://fastapi.tiangolo.com/
- SQLModel 文档: https://sqlmodel.tiangolo.com/
- OpenAI API 文档: https://platform.openai.com/docs

### 14.3 联系方式

- 项目路径: `/home/sam/Github/AI-RSS-Hub`
- 数据库文件: `ai_rss_hub.db`

---

**文档结束**

> 本文档旨在提供完整的项目信息，用于 AI 辅助评价和优化建议。
> 如有疑问或需要更多信息，请参考项目中的相关文档。
