# AI-RSS-Hub 功能说明书

**版本**: 1.0
**发布日期**: 2026-01-09
**项目地址**: https://github.com/goodniuniu/AI-RSS-Hub

---

## 目录

1. [产品概述](#1-产品概述)
2. [核心功能](#2-核心功能)
3. [技术架构](#3-技术架构)
4. [功能模块详解](#4-功能模块详解)
5. [API 接口说明](#5-api-接口说明)
6. [安全机制](#6-安全机制)
7. [部署运维](#7-部署运维)
8. [配置说明](#8-配置说明)
9. [使用指南](#9-使用指南)
10. [常见问题](#10-常见问题)

---

## 1. 产品概述

### 1.1 产品简介

AI-RSS-Hub 是一个**智能 RSS 聚合系统**，自动抓取多个 RSS 源并使用 AI 生成中英文双语摘要。系统提供 RESTful API 和标准 RSS 2.0 订阅源，支持多种过滤和查询方式。

### 1.2 核心价值

- **信息聚合**: 自动从多个 RSS 源抓取最新资讯
- **AI 摘要**: 使用大语言模型生成简洁的摘要
- **双语支持**: 同时生成中文和英文摘要，适合语言学习
- **灵活订阅**: 支持标准 RSS 2.0 格式，兼容所有阅读器
- **开放 API**: 提供 RESTful API 便于第三方集成

### 1.3 目标用户

- 个人用户：资讯聚合、技术追踪、语言学习
- 开发者：API 集成、二次开发、功能扩展
- 企业：内部知识库、竞品监控、行业资讯

### 1.4 技术特点

- **现代化架构**: 基于 FastAPI 和 SQLModel
- **生产就绪**: systemd 服务支持，自动重启
- **安全可靠**: 多层安全防护，完善的监控机制
- **易于部署**: 一键安装，配置简单
- **开源免费**: MIT 许可证，可自由使用和修改

---

## 2. 核心功能

### 2.1 功能清单

| 功能模块 | 功能描述 | 状态 |
|---------|---------|------|
| RSS 抓取 | 自动抓取多个 RSS 源的最新文章 | ✅ |
| 文章去重 | 基于链接自动去重，避免重复 | ✅ |
| AI 摘要 | 自动生成中文和英文摘要 | ✅ |
| 定时任务 | 可配置间隔的自动抓取 | ✅ |
| RESTful API | 完整的 CRUD 操作接口 | ✅ |
| RSS 订阅 | 标准 RSS 2.0 输出 | ✅ |
| 日期过滤 | 按日期/范围/天数查询 | ✅ |
| 分类筛选 | 按分类过滤文章 | ✅ |
| API 监控 | 自动记录请求性能数据 | ✅ |
| 安全认证 | API Token 认证机制 | ✅ |
| 速率限制 | 防止 API 滥用 | ✅ |
| 输入验证 | XSS/SSRF 防护 | ✅ |

### 2.2 功能特色

#### 2.2.1 双语 AI 摘要

- **单次调用**: 一次 API 请求同时生成中英文摘要
- **智能优化**: 自动控制摘要长度，确保信息密度
- **成本节约**: 相比分别生成节省 50% API 调用
- **语言学习**: 中英对照，适合英语学习场景

**示例**:
```
中文: 卓世科技已完成股份制改革及工商登记，主体类型变更为股份有限公司（非上市）。
英文: Zhuo Shi Technology has completed its shareholding reform and industrial and commercial
      registration, with its entity type upgraded to a "Joint Stock Limited Company (Non-listed)".
```

#### 2.2.2 灵活的日期过滤

支持三种日期查询模式，优先级从高到低：

1. **具体日期**: `date=2026-01-05` - 查询指定日期的文章
2. **日期范围**: `start_date=2026-01-01&end_date=2026-01-05` - 查询时间段内的文章
3. **相对时间**: `days=7` - 查询最近 N 天的文章

#### 2.2.3 多语言 RSS 输出

- **中文版**: `/api/rss` - 中文摘要
- **英文版**: `/api/rss/en` - 英文摘要
- **双语版**: `/api/rss/bilingual` - 中英文混合

支持 Feedly、Inoreader、NetNewsWire 等所有主流 RSS 阅读器。

#### 2.2.4 完善的 API 监控

自动记录每个 API 请求的：
- 请求路径和方法
- 响应时间（毫秒）
- 状态码
- 客户端 IP
- User-Agent

提供统计接口 `/api/stats` 查看性能数据。

---

## 3. 技术架构

### 3.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         客户端层                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  RSS阅读器│  │  Web前端 │  │ Python客户端│ │  移动应用 │   │
│  └─────┬────┘  └─────┬────┘  └─────┬────┘  └─────┬────┘   │
└────────┼───────────────┼──────────────┼───────────────┼─────┘
         │               │              │               │
         └───────────────┴──────────────┴───────────────┘
                           │
         ┌─────────────────┴─────────────────┐
         │                                     │
    ┌────▼────┐                          ┌───▼────┐
    │ RSS订阅  │                          │ API调用 │
    └────┬────┘                          └───┬────┘
         │                                    │
         └────────────┬───────────────────────┘
                      │
         ┌────────────▼──────────────────────┐
         │      API 网关层 (FastAPI)          │
         │  ┌─────────────────────────────┐  │
         │  │   安全中间件                 │  │
         │  │  - 认证                     │  │
         │  │  - 速率限制                 │  │
         │  │  - 输入验证                 │  │
         │  │  - 监控日志                 │  │
         │  └─────────────────────────────┘  │
         └────────────┬──────────────────────┘
                      │
         ┌────────────▼──────────────────────┐
         │         业务逻辑层                 │
         │  ┌──────────┐  ┌──────────────┐  │
         │  │ RSS抓取  │  │  AI摘要生成  │  │
         │  │  服务    │  │    服务      │  │
         │  └──────────┘  └──────────────┘  │
         │  ┌──────────┐  ┌──────────────┐  │
         │  │ RSS生成  │  │  定时调度    │  │
         │  │  服务    │  │    服务      │  │
         │  └──────────┘  └──────────────┘  │
         └────────────┬──────────────────────┘
                      │
         ┌────────────▼──────────────────────┐
         │         数据访问层                 │
         │  ┌─────────────────────────────┐  │
         │  │   CRUD 操作                 │  │
         │  │   数据库会话管理            │  │
         │  └─────────────────────────────┘  │
         └────────────┬──────────────────────┘
                      │
         ┌────────────▼──────────────────────┐
         │      SQLite 数据库                │
         │  ┌──────────┐  ┌──────────────┐  │
         │  │  feed    │  │   article    │  │
         │  │   表     │  │     表       │  │
         │  └──────────┘  └──────────────┘  │
         │  ┌─────────────────────────────┐  │
         │  │   api_request_log 表        │  │
         │  └─────────────────────────────┘  │
         └───────────────────────────────────┘
                      │
         ┌────────────▼──────────────────────┐
         │      外部服务                     │
         │  ┌──────────┐  ┌──────────────┐  │
         │  │ RSS 源   │  │  LLM API     │  │
         │  │ (HTTPS)  │  │  (OpenAI)    │  │
         │  └──────────┘  └──────────────┘  │
         └───────────────────────────────────┘
```

### 3.2 技术栈

#### 3.2.1 后端框架

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.10+ | 开发语言 |
| FastAPI | 0.115.5 | Web 框架 |
| Uvicorn | 0.34.0 | ASGI 服务器 |
| SQLModel | 0.0.22 | ORM |
| SQLAlchemy | 2.0.36 | ORM 核心 |

#### 3.2.2 数据存储

| 技术 | 版本 | 用途 |
|------|------|------|
| SQLite | 3.x | 主数据库 |
| WAL 模式 | - | 提升并发性能 |

#### 3.2.3 RSS 处理

| 技术 | 版本 | 用途 |
|------|------|------|
| feedparser | 6.0.11 | RSS 解析 |
| feedgen | 1.0.0 | RSS 2.0 生成 |

#### 3.2.4 AI 服务

| 技术 | 版本 | 用途 |
|------|------|------|
| OpenAI SDK | 1.58.1 | LLM API 调用 |
| httpx | 0.27.2 | 异步 HTTP 客户端 |

#### 3.2.5 任务调度

| 技术 | 版本 | 用途 |
|------|------|------|
| APScheduler | 3.10.4 | 定时任务 |

#### 3.2.6 安全工具

| 技术 | 版本 | 用途 |
|------|------|------|
| slowapi | 0.1.9 | 速率限制 |
| python-jose | 3.3.0 | JWT (预留) |
| passlib | 1.7.4 | 密码哈希 (预留) |
| bandit | 1.7.6 | 代码安全检查 |
| safety | 3.2.0 | 依赖漏洞扫描 |

### 3.3 分层架构

系统采用经典的三层架构：

#### 3.3.1 表现层 (API Layer)

**文件**: `app/api/routes.py` (553 行)

**职责**:
- 定义 RESTful API 端点
- 处理 HTTP 请求和响应
- 参数验证和序列化
- 调用业务逻辑层

**主要端点**:
- `/api/feeds` - Feed 管理
- `/api/articles` - Article 查询
- `/api/rss` - RSS 订阅
- `/api/stats` - 统计数据

#### 3.3.2 业务逻辑层 (Service Layer)

**目录**: `app/services/`

**职责**:
- RSS 抓取逻辑
- AI 摘要生成
- RSS 生成
- 业务规则实现

**核心服务**:
- `rss_fetcher.py` - RSS 抓取 (283 行)
- `summarizer.py` - AI 摘要 (423 行)
- `rss_generator.py` - RSS 输出 (263 行)

#### 3.3.3 数据访问层 (Data Access Layer)

**文件**: `app/crud.py` (178 行)

**职责**:
- 数据库 CRUD 操作
- 复杂查询逻辑
- 事务管理

**主要操作**:
- Feed 操作: create, get_all, get_by_id, get_by_url, update
- Article 操作: create, get_by_link, get_articles, update_summary
- 高级查询: 支持日期过滤、分类筛选

---

## 4. 功能模块详解

### 4.1 RSS 抓取模块

**文件**: `app/services/rss_fetcher.py` (283 行)

#### 4.1.1 功能描述

自动从多个 RSS 源抓取最新文章，解析内容，去重存储，并触发 AI 摘要生成。

#### 4.1.2 核心特性

- **异步处理**: 使用 asyncio 并发处理多个 RSS 源
- **智能去重**: 基于文章链接自动去重
- **时间解析**: 支持多种时间格式（RFC 2822, ISO 8601 等）
- **并发控制**: 使用信号量限制并发摘要生成数量
- **错误恢复**: 单个源失败不影响其他源

#### 4.1.3 工作流程

```
1. 获取所有活跃的 RSS 源
   ↓
2. 逐个解析 RSS 源
   ↓
3. 提取文章信息
   ↓
4. 检查文章是否已存在（基于链接）
   ↓
5. 新文章存入数据库
   ↓
6. 并发生成双语摘要
   ↓
7. 返回统计信息
```

#### 4.1.4 API 接口

**手动触发抓取**:
```http
POST /api/feeds/fetch
Authorization: X-API-Token: your_token
```

**响应示例**:
```json
{
  "status": "success",
  "message": "成功抓取 7 个源，获取 129 篇新文章",
  "stats": {
    "total_feeds": 7,
    "total_articles": 129,
    "success_feeds": 7,
    "failed_feeds": 0
  }
}
```

#### 4.1.5 定时任务

默认每小时自动执行一次，可通过环境变量配置：

```bash
FETCH_INTERVAL_HOURS=1  # 每 1 小时抓取一次
```

### 4.2 AI 摘要模块

**文件**: `app/services/summarizer.py` (423 行)

#### 4.2.1 功能描述

使用大语言模型（LLM）自动生成文章的中英文双语摘要。

#### 4.2.2 核心特性

- **双语生成**: 一次 API 调用同时生成中英文摘要
- **长度控制**: 自动控制摘要长度（中文 100 字，英文 200 词）
- **异步支持**: 支持异步和同步两种模式
- **并发控制**: 使用信号量防止 API 过载
- **错误降级**: API 失败时生成简化摘要
- **超时处理**: 30 秒超时保护

#### 4.2.3 Prompt 工程

**系统提示词**:
```
你是一个专业的新闻摘要助手。请用简洁的语言总结这篇文章的主要内容。

要求：
1. 中文摘要控制在100字以内
2. 英文摘要控制在200词以内
3. 保持客观准确
4. 突出核心信息
```

#### 4.2.4 参数配置

```python
temperature = 0.3      # 降低随机性，提高一致性
max_tokens = 500       # 双语摘要最大 token 数
timeout = 30           # 请求超时时间（秒）
```

#### 4.2.5 API 调用示例

```python
from app.services.summarizer import summarize_article_bilingual

result = summarize_article_bilingual(
    title="文章标题",
    content="文章内容...",
    session=db_session
)

# 返回
{
    "summary_zh": "中文摘要...",
    "summary_en": "English summary..."
}
```

#### 4.2.6 错误处理

- **超时错误**: 降级为生成长摘要
- **速率限制**: 自动重试（指数退避）
- **API 错误**: 返回错误信息，不阻塞流程
- **并发限制**: 使用信号量控制（默认 2 个并发）

### 4.3 RSS 生成模块

**文件**: `app/services/rss_generator.py` (263 行)

#### 4.3.1 功能描述

为文章数据生成标准的 RSS 2.0 格式输出，兼容所有主流 RSS 阅读器。

#### 4.3.2 核心特性

- **标准格式**: 完全符合 RSS 2.0 规范
- **多语言支持**: 中文/英文/双语三种模式
- **HTML 描述**: 支持富文本格式
- **来源追踪**: 自动添加源信息
- **灵活过滤**: 支持分类和时间过滤

#### 4.3.3 RSS 结构

```xml
<?xml version='1.0' encoding='UTF-8'?>
<rss version="2.0">
  <channel>
    <title>AI-RSS-Hub 智能资讯</title>
    <link>http://localhost:8000</link>
    <description>AI 智能聚合的 RSS 资讯源</description>
    <language>zh-cn</language>
    <lastBuildDate>Mon, 09 Jan 2026 11:27:57 +0000</lastBuildDate>

    <item>
      <title>文章标题</title>
      <link>https://example.com/article</link>
      <description>
        <strong>中文摘要：</strong><br/>
        中文摘要内容...<br/><br/>
        <a href="...">阅读原文</a> | 来源: 36Kr
      </description>
      <guid isPermaLink="false">https://example.com/article</guid>
      <pubDate>Mon, 09 Jan 2026 11:27:57 +0000</pubDate>
      <author>36Kr</author>
      <category>tech</category>
    </item>
  </channel>
</rss>
```

#### 4.3.4 订阅端点

| 端点 | 摘要语言 | 说明 |
|------|---------|------|
| `/api/rss` | 中文 | 默认订阅源 |
| `/api/rss/en` | 英文 | 英文摘要 |
| `/api/rss/bilingual` | 双语 | 中英文混合 |
| `/api/rss/category/{category}` | 中文 | 分类订阅 |

#### 4.3.5 查询参数

- `category`: 按分类过滤（tech, science, development 等）
- `days`: 最近 N 天的文章（1-30）
- `limit`: 返回数量限制（1-200，默认 50）

**示例**:
```
/api/rss?category=tech&days=7&limit=100
```

### 4.4 定时调度模块

**文件**: `app/scheduler.py` (100 行)

#### 4.4.1 功能描述

使用 APScheduler 实现定时 RSS 抓取任务。

#### 4.4.2 配置选项

```python
# 环境变量
FETCH_INTERVAL_HOURS = 1  # 抓取间隔（小时）

# 调度器配置
scheduler = BackgroundScheduler()
trigger = 'interval'
hours = 1
max_instances = 1  # 防止任务重叠
```

#### 4.4.3 任务状态查询

```http
GET /api/status
```

**响应**:
```json
{
  "scheduler_running": true,
  "next_run_time": "2026-01-09T20:00:00",
  "last_fetch_stats": {
    "total_feeds": 7,
    "total_articles": 129
  }
}
```

---

## 5. API 接口说明

### 5.1 API 概览

| 分类 | 端点 | 方法 | 认证 | 说明 |
|------|------|------|------|------|
| 健康检查 | `/api/health` | GET | ❌ | 服务健康状态 |
| 系统状态 | `/api/status` | GET | ❌ | 调度器状态 |
| 统计数据 | `/api/stats` | GET | ❌ | API 使用统计 |
| Feed 管理 | `/api/feeds` | GET | ❌ | 获取所有 Feed |
| Feed 管理 | `/api/feeds` | POST | ✅ | 添加新 Feed |
| 文章查询 | `/api/articles` | GET | ❌ | 获取文章列表 |
| 手动抓取 | `/api/feeds/fetch` | POST | ✅ | 触发 RSS 抓取 |
| RSS 订阅 | `/api/rss` | GET | ❌ | RSS 订阅源 |
| RSS 订阅 | `/api/rss/{type}` | GET | ❌ | 指定语言订阅 |
| RSS 订阅 | `/api/rss/category/{cat}` | GET | ❌ | 分类订阅 |

### 5.2 认证机制

#### 5.2.1 API Token 认证

需要认证的端点使用 `X-API-Token` 请求头：

```http
POST /api/feeds
X-API-Token: your_token_here
Content-Type: application/json
```

#### 5.2.2 获取 API Token

Token 存储在环境变量 `.env` 中：

```bash
API_TOKEN=your_secure_token_here
```

生成安全 Token：
```bash
python scripts/security/generate_token.py
```

### 5.3 公开端点

#### 5.3.1 健康检查

```http
GET /api/health
```

**响应**:
```json
{
  "status": "ok",
  "message": "AI-RSS-Hub is running"
}
```

#### 5.3.2 系统状态

```http
GET /api/status
```

**响应**:
```json
{
  "scheduler_running": true,
  "next_run_time": "2026-01-09T20:00:00",
  "database_status": "ok",
  "total_feeds": 7,
  "total_articles": 652
}
```

#### 5.3.3 获取所有 Feed

```http
GET /api/feeds?active_only=true
```

**参数**:
- `active_only`: 仅返回活跃的源（默认 false）

**响应**:
```json
[
  {
    "id": 1,
    "name": "36Kr",
    "url": "https://36kr.com/feed",
    "category": "tech",
    "is_active": true,
    "created_at": "2026-01-01T00:00:00"
  }
]
```

#### 5.3.4 获取文章列表

```http
GET /api/articles?limit=10&category=tech&days=7
```

**参数**:
- `limit`: 返回数量（1-200，默认 50）
- `category`: 按分类过滤
- `days`: 最近 N 天（1-365）
- `date`: 具体日期（YYYY-MM-DD）
- `start_date`: 开始日期（YYYY-MM-DD）
- `end_date`: 结束日期（YYYY-MM-DD）

**响应**:
```json
[
  {
    "id": 651,
    "title": "国恩科技递表港交所",
    "link": "https://36kr.com/newsflashes/3632104698840067",
    "summary": "国恩科技向港交所提交上市申请...",
    "summary_en": "Guoen Technology has submitted a listing application...",
    "published_at": "2026-01-09T11:27:57",
    "feed_id": 6,
    "feed_name": "36Kr",
    "created_at": "2026-01-09T19:33:24"
  }
]
```

#### 5.3.5 API 使用统计

```http
GET /api/stats?hours=24
```

**参数**:
- `hours`: 统计最近几小时（1-168，默认 24）

**响应**:
```json
{
  "period_hours": 24,
  "endpoints": [
    {
      "path": "/api/articles",
      "method": "GET",
      "requests_24h": 1234,
      "avg_response_time_ms": 45.2,
      "success_rate": 99.8
    }
  ],
  "overall": {
    "total_requests": 5678,
    "avg_response_time_ms": 52.3,
    "success_rate": 99.5
  },
  "system": {
    "active_feeds": 7,
    "total_articles": 652
  }
}
```

### 5.4 受保护端点

#### 5.4.1 添加新 Feed

```http
POST /api/feeds
X-API-Token: your_token
Content-Type: application/json

{
  "name": "Tech Blog",
  "url": "https://example.com/feed",
  "category": "tech"
}
```

**参数验证**:
- `name`: 1-200 字符，不能包含 HTML 标签
- `url`: 1-2048 字符，有效 URL，不能是内网地址
- `category`: 0-50 字符

**响应**:
```json
{
  "id": 8,
  "name": "Tech Blog",
  "url": "https://example.com/feed",
  "category": "tech",
  "is_active": true,
  "created_at": "2026-01-09T20:00:00"
}
```

**错误响应**:
```json
{
  "detail": "RSS 源已存在: https://example.com/feed"
}
```

#### 5.4.2 手动触发抓取

```http
POST /api/feeds/fetch
X-API-Token: your_token
```

**响应**:
```json
{
  "status": "success",
  "message": "成功抓取 7 个源，获取 129 篇新文章",
  "stats": {
    "total_feeds": 7,
    "total_articles": 129,
    "success_feeds": 7,
    "failed_feeds": 0
  }
}
```

### 5.5 RSS 订阅端点

#### 5.5.1 主订阅源

**中文摘要**:
```http
GET /api/rss?limit=50
```

**英文摘要**:
```http
GET /api/rss/en?limit=50
```

**双语混合**:
```http
GET /api/rss/bilingual?limit=50
```

#### 5.5.2 分类订阅

```http
GET /api/rss?category=tech&days=7&limit=100
```

#### 5.5.3 按分类路径订阅

```http
GET /api/rss/category/tech?summary_type=en&days=7
```

### 5.6 错误响应

所有错误响应遵循统一格式：

```json
{
  "detail": "错误描述信息"
}
```

**常见 HTTP 状态码**:
- `200 OK` - 请求成功
- `400 Bad Request` - 请求参数错误
- `401 Unauthorized` - 未授权（缺少或无效 Token）
- `404 Not Found` - 资源不存在
- `429 Too Many Requests` - 超过速率限制
- `500 Internal Server Error` - 服务器内部错误

---

## 6. 安全机制

### 6.1 认证与授权

#### 6.1.1 API Token 认证

**实现文件**: `app/security/auth.py` (68 行)

**机制**:
- 简单 Token 比对
- 通过环境变量配置
- 开发模式支持降级（未配置时跳过验证）

**使用方式**:
```python
from app.security.auth import verify_api_token

@router.post("/api/feeds")
def add_feed(
    feed_data: FeedCreate,
    authenticated: bool = Depends(verify_api_token)
):
    # authenticated 必须为 True 才能执行
    pass
```

#### 6.1.2 Token 生成

**文件**: `scripts/security/generate_token.py`

**方法**:
- 使用 `secrets.token_urlsafe(32)`
- 生成 256 位随机 Token
- Base64 URL 安全编码

**示例**:
```python
import secrets

token = secrets.token_urlsafe(32)
# 输出: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4"
```

### 6.2 输入验证

#### 6.2.1 URL 验证

**文件**: `app/security/validators.py` (131 行)

**验证项**:
- URL 格式（正则表达式）
- 长度限制（最大 2048 字符）
- SSRF 防护（拒绝内网地址）

**被阻止的内网地址**:
- `127.0.0.1`, `localhost`, `0.0.0.0`
- `192.168.x.x`
- `10.x.x.x`
- `172.16.x.x` - `172.31.x.x`
- `169.254.x.x`

**实现**:
```python
class URLValidator:
    PRIVATE_PATTERNS = [
        r'127\.0\.0\.1',
        r'localhost',
        r'192\.168\.\d+\.\d+',
        r'10\.\d+\.\d+\.\d+',
        # ...
    ]

    def validate(self, url: str) -> bool:
        # 1. 格式验证
        if not re.match(self.URL_PATTERN, url):
            return False

        # 2. SSRF 防护
        for pattern in self.PRIVATE_PATTERNS:
            if re.search(pattern, url, re.IGNORECASE):
                return False

        return True
```

#### 6.2.2 XSS 防护

**HTML 转义**:
```python
import html

def sanitize_name(name: str) -> str:
    # 转义 HTML 特殊字符
    return html.escape(name, quote=True)
```

**被转义的字符**:
- `<` → `&lt;`
- `>` → `&gt;`
- `&` → `&amp;`
- `"` → `&quot;`
- `'` → `&#x27;`

### 6.3 速率限制

**文件**: `app/security/rate_limiter.py` (54 行)

**实现**:
- 使用 `slowapi` 库
- 基于内存存储（单实例）
- 默认：60 次 / 60 秒

**配置**:
```bash
RATE_LIMIT_ENABLED=true
RATE_LIMIT_TIMES=60
RATE_LIMIT_SECONDS=60
```

**使用方式**:
```python
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(
    key_func=get_remote_address,
    default_limits=["60/minute"]
)

@app.get("/api/articles")
@limiter.limit("60/minute")
def get_articles():
    pass
```

**响应**:
```http
HTTP/1.1 429 Too Many Requests
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1641723456

{
  "detail": "请求过于频繁，请稍后再试"
}
```

### 6.4 安全响应头

**文件**: `app/security/middleware.py` (34 行)

**响应头列表**:
```http
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000; includeSubDomains
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: geolocation=(), microphone=(), camera=()
```

**实现**:
```python
class SecurityHeadersMiddleware:
    async def __call__(self, request: Request, call_next):
        response = await call_next(request)

        # 添加安全响应头
        response.headers["X-Content-Type-Options"] = "nosniff"
        response.headers["X-Frame-Options"] = "DENY"
        # ...

        return response
```

### 6.5 API 监控

**文件**: `app/security/api_monitoring.py` (200 行)

**监控数据**:
- 请求 ID（UUID）
- 请求路径和方法
- 响应时间（毫秒）
- 状态码
- 客户端 IP
- User-Agent
- 错误信息（如有）

**数据库表**:
```sql
CREATE TABLE api_request_log (
    id INTEGER PRIMARY KEY,
    request_id VARCHAR(36),
    method VARCHAR(10),
    path VARCHAR(255),
    status_code INTEGER,
    response_time_ms REAL,
    client_ip VARCHAR(45),
    user_agent TEXT,
    error_msg TEXT,
    created_at DATETIME
)
```

**慢请求检测**:
- 阈值：1000ms
- 标记：在日志中标记为 "SLOW"

### 6.6 安全日志

**文件**: `app/security/logger.py` (89 行)

**敏感数据过滤**:
```python
SENSITIVE_FIELDS = [
    'api_key', 'token', 'password',
    'secret', 'authorization'
]

def filter_sensitive_data(log_message: str) -> str:
    for field in SENSITIVE_FIELDS:
        pattern = f'{field}=[^\\s]+'
        log_message = re.sub(
            pattern,
            f'{field}=***FILTERED***',
            log_message,
            flags=re.IGNORECASE
        )
    return log_message
```

**日志格式**:
```
2026-01-09 20:00:00,000 - app.api.routes - INFO - API Request: {'api_token': '***FILTERED***'}
```

---

## 7. 部署运维

### 7.1 系统要求

#### 7.1.1 硬件要求

| 资源 | 最低配置 | 推荐配置 |
|------|---------|---------|
| CPU | 1 核 | 2+ 核 |
| 内存 | 512 MB | 1 GB+ |
| 磁盘 | 500 MB | 2 GB+ |
| 网络 | 1 Mbps | 10 Mbps+ |

#### 7.1.2 软件要求

| 软件 | 版本 | 说明 |
|------|------|------|
| Python | 3.10+ | 开发语言 |
| pip | 最新版 | 包管理器 |
| systemd | 234+ | 系统服务管理（Linux） |
| SQLite | 3.x | 数据库 |

### 7.2 安装步骤

#### 7.2.1 获取代码

```bash
# 克隆仓库
git clone https://github.com/goodniuniu/AI-RSS-Hub.git
cd AI-RSS-Hub
```

#### 7.2.2 创建虚拟环境

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows
```

#### 7.2.3 安装依赖

```bash
pip install -r requirements.txt
```

#### 7.2.4 配置环境变量

```bash
# 复制配置模板
cp config/env/.env.example .env

# 编辑配置文件
nano .env
```

**必填配置**:
```bash
OPENAI_API_KEY=your_api_key_here
API_TOKEN=your_secure_token_here
```

**可选配置**:
```bash
OPENAI_API_BASE=https://api.openai.com/v1
OPENAI_MODEL=gpt-3.5-turbo
FETCH_INTERVAL_HOURS=1
CORS_ORIGINS=http://localhost:3000
RATE_LIMIT_ENABLED=true
```

#### 7.2.5 初始化数据库

```bash
# 首次启动自动创建数据库和表
python -m app.main
```

### 7.3 运行模式

#### 7.3.1 开发模式

**方式一：使用脚本**
```bash
./scripts/dev/start.sh
```

**方式二：直接运行**
```bash
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**特点**:
- 热重载（代码修改自动重启）
- 详细日志输出
- 调试模式

#### 7.3.2 生产模式

**使用 systemd 服务**（推荐 Linux）:

```bash
# 安装服务
sudo ./scripts/service/install_service.sh

# 启动服务
sudo systemctl start ai-rss-hub

# 设置开机自启
sudo systemctl enable ai-rss-hub

# 查看状态
sudo systemctl status ai-rss-hub

# 查看日志
sudo journalctl -u ai-rss-hub -f
```

**服务文件**: `config/systemd/ai-rss-hub.service`

```ini
[Unit]
Description=AI-RSS-Hub - Intelligent RSS Aggregation System
After=network.target

[Service]
Type=simple
User=sam
WorkingDirectory=/home/sam/Github/AI-RSS-Hub
Environment="PATH=/home/sam/Github/AI-RSS-Hub/venv/bin"
ExecStart=/home/sam/Github/AI-RSS-Hub/venv/bin/python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**服务管理命令**:
```bash
# 启动
sudo systemctl start ai-rss-hub

# 停止
sudo systemctl stop ai-rss-hub

# 重启
sudo systemctl restart ai-rss-hub

# 查看状态
sudo systemctl status ai-rss-hub

# 查看日志（实时）
sudo journalctl -u ai-rss-hub -f

# 查看日志（最近 100 行）
sudo journalctl -u ai-rss-hub -n 100

# 查看日志（指定时间段）
sudo journalctl -u ai-rss-hub --since "1 hour ago"
```

### 7.4 数据库管理

#### 7.4.1 数据库位置

```
/home/sam/Github/AI-RSS-Hub/ai_rss_hub.db
```

#### 7.4.2 备份数据库

```bash
# 方式一：直接复制
cp ai_rss_hub.db ai_rss_hub.db.backup

# 方式二：使用 SQLite 导出
sqlite3 ai_rss_hub.db .dump > backup.sql

# 方式三：定时备份脚本
#!/bin/bash
BACKUP_DIR="/backups/ai-rss-hub"
DATE=$(date +%Y%m%d_%H%M%S)
cp ai_rss_hub.db "$BACKUP_DIR/ai_rss_hub_$DATE.db"
# 保留最近 7 天的备份
find $BACKUP_DIR -name "ai_rss_hub_*.db" -mtime +7 -delete
```

#### 7.4.3 恢复数据库

```bash
# 停止服务
sudo systemctl stop ai-rss-hub

# 恢复备份
cp ai_rss_hub.db.backup ai_rss_hub.db

# 重启服务
sudo systemctl start ai-rss-hub
```

#### 7.4.4 数据库优化

**SQLite 性能配置**（已默认启用）:

```python
# WAL 模式（提高并发）
conn.execute("PRAGMA journal_mode=WAL")

# 同步模式
conn.execute("PRAGMA synchronous=NORMAL")

# 内存映射
conn.execute("PRAGMA mmap_size=268435456")  # 256MB

# 缓存大小
conn.execute("PRAGMA cache_size=-64000")  # 64MB

# 临时存储在内存
conn.execute("PRAGMA temp_store=MEMORY")
```

### 7.5 日志管理

#### 7.5.1 日志位置

**systemd 日志**:
```bash
sudo journalctl -u ai-rss-hub
```

**应用日志**:
- 开发模式：控制台输出
- 生产模式：systemd journal

#### 7.5.2 日志级别

```python
import logging

# 根日志
logging.getLogger().setLevel(logging.INFO)

# 第三方库（降低噪音）
logging.getLogger("uvicorn").setLevel(logging.WARNING)
logging.getLogger("fastapi").setLevel(logging.WARNING)
```

#### 7.5.3 日志查询

```bash
# 实时日志
sudo journalctl -u ai-rss-hub -f

# 最近 100 行
sudo journalctl -u ai-rss-hub -n 100

# 指定时间段
sudo journalctl -u ai-rss-hub --since "1 hour ago"
sudo journalctl -u ai-rss-hub --since today
sudo journalctl -u ai-rss-hub --since "2026-01-09" --until "2026-01-10"

# 按级别过滤
sudo journalctl -u ai-rss-hub -p err

# 按关键词过滤
sudo journalctl -u ai-rss-hub | grep "ERROR"
```

### 7.6 监控告警

#### 7.6.1 健康检查

```bash
# 简单健康检查
curl http://localhost:8000/api/health

# 完整状态检查
curl http://localhost:8000/api/status | jq
```

#### 7.6.2 性能监控

```bash
# API 统计（最近 24 小时）
curl "http://localhost:8000/api/stats?hours=24" | jq

# 检查慢请求
curl "http://localhost:8000/api/stats?hours=1" | jq '.slowest_requests'
```

#### 7.6.3 告警脚本示例

```bash
#!/bin/bash
# check_service.sh

# 检查服务状态
if ! systemctl is-active --quiet ai-rss-hub; then
    echo "CRITICAL: ai-rss-hub service is not running"
    # 发送告警（邮件/短信/钉钉）
    exit 2
fi

# 检查健康端点
HEALTH=$(curl -s http://localhost:8000/api/health)
if [[ $HEALTH != *"ok"* ]]; then
    echo "WARNING: Health check failed"
    exit 1
fi

# 检查最新文章时间
LATEST=$(curl -s "http://localhost:8000/api/articles?limit=1" | jq -r '.[0].published_at')
LATEST_TIMESTAMP=$(date -d "$LATEST" +%s)
CURRENT_TIMESTAMP=$(date +%s)
DIFF=$((CURRENT_TIMESTAMP - LATEST_TIMESTAMP))

# 如果超过 48 小时没有新文章，告警
if [ $DIFF -gt 172800 ]; then
    echo "WARNING: No new articles for 48 hours"
    exit 1
fi

echo "OK: All checks passed"
exit 0
```

**定时检查**（cron）:
```bash
# 每 5 分钟检查一次
*/5 * * * * /home/sam/scripts/check_service.sh
```

---

## 8. 配置说明

### 8.1 环境变量配置

**配置文件**: `.env`

#### 8.1.1 必填配置

```bash
# LLM API 密钥
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxx

# API 管理Token
API_TOKEN=your_secure_token_here
```

#### 8.1.2 LLM 配置

```bash
# OpenAI API 基础 URL（支持兼容接口）
OPENAI_API_BASE=https://api.openai.com/v1

# 使用的模型
OPENAI_MODEL=gpt-3.5-turbo

# 其他兼容接口示例：
# OPENAI_API_BASE=https://api.deepseek.com/v1
# OPENAI_API_BASE=https://api.qnaigc.com/v1
```

#### 8.1.3 RSS 抓取配置

```bash
# 抓取间隔（小时）
FETCH_INTERVAL_HOURS=1

# HTTP 请求超时（秒）
REQUEST_TIMEOUT=30
```

#### 8.1.4 AI 摘要配置

```bash
# 摘要最大长度（字）
SUMMARY_MAX_LENGTH=100

# LLM 请求超时（秒）
LLM_TIMEOUT=30

# 最大并发摘要数
MAX_CONCURRENT_SUMMARIES=2
```

#### 8.1.5 安全配置

```bash
# CORS 允许的源（逗号分隔）
CORS_ORIGINS=http://localhost:3000,http://localhost:8000

# 是否启用速率限制
RATE_LIMIT_ENABLED=true

# 速率限制：时间窗口内请求数
RATE_LIMIT_TIMES=60

# 速率限制：时间窗口（秒）
RATE_LIMIT_SECONDS=60
```

#### 8.1.6 数据库配置

```bash
# SQLite 数据库文件路径
DATABASE_URL=sqlite:///ai_rss_hub.db
```

#### 8.1.7 输入验证配置

```bash
# URL 最大长度
MAX_URL_LENGTH=2048

# 名称最大长度
MAX_NAME_LENGTH=200

# 分类最大长度
MAX_CATEGORY_LENGTH=50
```

### 8.2 代码配置

**文件**: `app/config.py` (54 行)

**Settings 类**（Pydantic Settings）:

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # 数据库
    database_url: str = "sqlite:///ai_rss_hub.db"

    # LLM API
    openai_api_key: str
    openai_api_base: str = "https://api.openai.com/v1"
    openai_model: str = "gpt-3.5-turbo"

    # RSS 抓取
    fetch_interval_hours: int = 1
    request_timeout: int = 30

    # AI 摘要
    summary_max_length: int = 100
    llm_timeout: int = 30
    max_concurrent_summaries: int = 2

    # 安全
    api_token: str
    cors_origins: str = "http://localhost:3000"
    rate_limit_enabled: bool = True
    rate_limit_times: int = 60
    rate_limit_seconds: int = 60

    # 验证
    max_url_length: int = 2048
    max_name_length: int = 200
    max_category_length: int = 50

    class Config:
        env_file = ".env"
        case_sensitive = False

settings = Settings()
```

### 8.3 配置优先级

1. **环境变量** (最高优先级)
2. **.env 文件**
3. **代码默认值** (最低优先级)

**示例**:
```python
# 代码默认值
openai_model: str = "gpt-3.5-turbo"

# .env 文件
OPENAI_MODEL=gpt-4

# 环境变量
export OPENAI_MODEL=gpt-4-turbo

# 最终使用：gpt-4-turbo（环境变量优先级最高）
```

---

## 9. 使用指南

### 9.1 快速开始

#### 9.1.1 启动服务

```bash
# 开发模式
./scripts/dev/start.sh

# 或生产模式
sudo systemctl start ai-rss-hub
```

#### 9.1.2 验证服务

```bash
curl http://localhost:8000/api/health
```

**预期输出**:
```json
{
  "status": "ok",
  "message": "AI-RSS-Hub is running"
}
```

### 9.2 API 使用示例

#### 9.2.1 获取最新文章

```bash
curl "http://localhost:8000/api/articles?limit=10"
```

#### 9.2.2 获取今天的文章

```bash
curl "http://localhost:8000/api/articles?date=2026-01-09"
```

#### 9.2.3 获取最近 7 天的科技文章

```bash
curl "http://localhost:8000/api/articles?category=tech&days=7&limit=50"
```

#### 9.2.4 添加新 RSS 源

```bash
curl -X POST http://localhost:8000/api/feeds \
  -H "Content-Type: application/json" \
  -H "X-API-Token: your_token" \
  -d '{
    "name": "TechCrunch",
    "url": "https://techcrunch.com/feed/",
    "category": "tech"
  }'
```

#### 9.2.5 手动触发抓取

```bash
curl -X POST http://localhost:8000/api/feeds/fetch \
  -H "X-API-Token: your_token"
```

### 9.3 RSS 订阅

#### 9.3.1 Feedly 订阅

1. 打开 Feedly
2. 点击 "添加内容"
3. 输入：`http://your-server:8000/api/rss`
4. 点击 "关注"

#### 9.3.2 Inoreader 订阅

1. 打开 Inoreader
2. 点击 "订阅"
3. 输入：`http://your-server:8000/api/rss/en`
4. 点击 "订阅"

#### 9.3.3 按分类订阅

```bash
# 科技分类（中文）
http://your-server:8000/api/rss?category=tech

# 科学分类（英文）
http://your-server:8000/api/rss/en?category=science

# 最近 7 天文章
http://your-server:8000/api/rss?days=7
```

### 9.4 Python 客户端使用

#### 9.4.1 安装

```bash
# 项目已包含客户端库
# utils/rss_client.py
```

#### 9.4.2 基础使用

```python
from utils.rss_client import RSSHubClient

# 初始化客户端
client = RSSHubClient(
    base_url="http://localhost:8000",
    api_token="your_token"  # 管理操作需要
)

# 健康检查
health = client.health_check()
print(health)

# 获取最新文章
articles = client.get_latest_articles(limit=10)
for article in articles:
    print(f"{article['title']}: {article['summary']}")

# 搜索文章
results = client.search_articles("AI", limit=20)
```

#### 9.4.3 高级用法

```python
# 按日期获取
articles = client.get_articles_by_date(
    date="2026-01-09",
    limit=50
)

# 日期范围
articles = client.get_articles_by_date_range(
    start_date="2026-01-01",
    end_date="2026-01-09",
    limit=100
)

# 最近 N 天
articles = client.get_recent_articles(days=7, limit=50)

# 按 Feed 获取
articles = client.get_articles_by_feed(
    feed_id=1,
    limit=20
)

# 添加新 Feed
new_feed = client.add_feed(
    name="New Blog",
    url="https://example.com/feed",
    category="tech"
)

# 手动抓取
stats = client.fetch_feeds()
print(f"抓取了 {stats['total_articles']} 篇新文章")
```

### 9.5 批量添加 RSS 源

**脚本**: `utils/example_usage.py`

```python
from utils.rss_client import RSSHubAdminClient

admin = RSSHubAdminClient(
    base_url="http://localhost:8000",
    api_token="your_token"
)

# 批量添加
feeds = [
    {"name": "36Kr", "url": "https://36kr.com/feed", "category": "tech-china"},
    {"name": "TechCrunch", "url": "https://techcrunch.com/feed/", "category": "tech"},
    {"name": "Hacker News", "url": "https://news.ycombinator.com/rss", "category": "development"},
]

result = admin.bulk_add_feeds(feeds)
print(f"成功添加 {result['success_count']} 个源")
```

---

## 10. 常见问题

### 10.1 安装问题

#### Q1: pip install 失败

**问题**: `pip install -r requirements.txt` 报错

**解决方案**:
```bash
# 更新 pip
pip install --upgrade pip

# 使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 或逐个安装问题包
pip install package_name==version
```

#### Q2: 虚拟环境创建失败

**问题**: `python3 -m venv venv` 报错

**解决方案**:
```bash
# 安装 venv 模块
sudo apt install python3-venv  # Ubuntu/Debian
sudo yum install python3-venv  # CentOS/RHEL

# 或使用 virtualenv
pip install virtualenv
virtualenv venv
```

### 10.2 配置问题

#### Q3: API 调用失败 (401)

**问题**: 添加 Feed 或手动抓取时返回 401 错误

**解决方案**:
```bash
# 检查 API_TOKEN 是否配置
cat .env | grep API_TOKEN

# 生成新 Token
python scripts/security/generate_token.py

# 更新 .env 文件
API_TOKEN=新生成的Token

# 重启服务
sudo systemctl restart ai-rss-hub
```

#### Q4: LLM API 调用失败

**问题**: 摘要生成失败，日志显示 API 错误

**解决方案**:
```bash
# 检查 API Key
cat .env | grep OPENAI_API_KEY

# 测试 API 连接
curl https://api.openai.com/v1/models \
  -H "Authorization: Bearer $OPENAI_API_KEY"

# 如果使用兼容接口，检查配置
OPENAI_API_BASE=https://api.deepseek.com/v1

# 检查网络连接
curl -I https://api.openai.com
```

### 10.3 运行问题

#### Q5: 服务无法启动

**问题**: `systemctl start ai-rss-hub` 失败

**解决方案**:
```bash
# 查看详细错误
sudo journalctl -u ai-rss-hub -n 50

# 常见原因：
# 1. 端口被占用
sudo lsof -i :8000
sudo kill -9 <PID>

# 2. 权限问题
sudo chown -R $USER:$USER /home/sam/Github/AI-RSS-Hub

# 3. 配置文件错误
python -m app.main  # 手动运行查看错误
```

#### Q6: 定时任务不执行

**问题**: 没有自动抓取新文章

**解决方案**:
```bash
# 检查调度器状态
curl http://localhost:8000/api/status

# 检查日志
sudo journalctl -u ai-rss-hub --since "1 hour ago" | grep scheduler

# 手动触发测试
curl -X POST http://localhost:8000/api/feeds/fetch \
  -H "X-API-Token: your_token"

# 检查配置
cat .env | grep FETCH_INTERVAL_HOURS
```

#### Q7: 数据库锁定

**问题**: SQLite 数据库锁定错误

**解决方案**:
```bash
# 停止服务
sudo systemctl stop ai-rss-hub

# 删除锁文件
rm ai_rss_hub.db-shm
rm ai_rss_hub.db-wal

# 重启服务
sudo systemctl start ai-rss-hub

# 或使用 SQLite 命令检查
sqlite3 ai_rss_hub.db "PRAGMA integrity_check;"
```

### 10.4 性能问题

#### Q8: API 响应慢

**问题**: API 请求响应时间长

**解决方案**:
```bash
# 查看性能统计
curl "http://localhost:8000/api/stats?hours=1" | jq '.slowest_requests'

# 优化建议：
# 1. 增加 SQLite 缓存（已在代码中配置）
# 2. 减少 limit 参数
curl "http://localhost:8000/api/articles?limit=10"

# 3. 使用日期过滤减少数据量
curl "http://localhost:8000/api/articles?days=1"

# 4. 检查系统资源
htop
df -h
```

#### Q9: 内存占用高

**问题**: 服务占用内存持续增长

**解决方案**:
```bash
# 查看内存使用
ps aux | grep uvicorn

# 重启服务
sudo systemctl restart ai-rss-hub

# 减少并发数
# .env
MAX_CONCURRENT_SUMMARIES=1

# 减少批处理大小
# 修改 rss_fetcher.py 中的并发控制
```

### 10.5 安全问题

#### Q10: 速率限制触发

**问题**: API 返回 429 错误

**解决方案**:
```bash
# 调整速率限制
# .env
RATE_LIMIT_TIMES=120  # 增加限制
RATE_LIMIT_SECONDS=60

# 或使用 API Token（有更高的限制）
curl -H "X-API-Token: your_token" \
  "http://localhost:8000/api/articles?limit=100"
```

#### Q11: 恶意 Feed 添加

**问题**: 有人添加了恶意的 RSS 源

**解决方案**:
```bash
# 禁用 Feed
# 需要实现 API 端点
curl -X PUT http://localhost:8000/api/feeds/{feed_id} \
  -H "X-API-Token: your_token" \
  -d '{"is_active": false}'

# 或直接删除
# 使用 SQLite
sqlite3 ai_rss_hub.db "DELETE FROM feed WHERE id = {feed_id};"
```

### 10.6 数据问题

#### Q12: 文章重复

**问题**: 出现重复的文章

**解决方案**:
```bash
# 检查去重逻辑
# 已基于 link 字段建立唯一索引

# 手动清理重复
sqlite3 ai_rss_hub.db "
DELETE FROM article
WHERE id NOT IN (
    SELECT MIN(id)
    FROM article
    GROUP BY link
);
"
```

#### Q13: 摘要质量差

**问题**: 生成的摘要质量不好

**解决方案**:
```bash
# 1. 调整 Prompt
# 编辑 app/services/summarizer.py

# 2. 更换模型
OPENAI_MODEL=gpt-4  # 更好的模型

# 3. 调整温度参数
# 修改 summarizer.py 中的 temperature
temperature = 0.7  # 增加创造性

# 4. 重新生成摘要
python utils/regenerate_summaries.py --limit=10
```

---

## 附录

### A. 项目文件清单

#### A.1 核心代码文件

```
app/
├── main.py (149 行)                    # 应用入口
├── config.py (54 行)                   # 配置管理
├── models.py (97 行)                   # 数据模型
├── crud.py (178 行)                    # CRUD 操作
├── database.py (122 行)                # 数据库连接
├── scheduler.py (100 行)               # 定时任务
├── api/
│   └── routes.py (553 行)              # API 路由
├── services/
│   ├── rss_fetcher.py (283 行)         # RSS 抓取
│   ├── summarizer.py (423 行)          # AI 摘要
│   └── rss_generator.py (263 行)       # RSS 生成
└── security/
    ├── auth.py (68 行)                 # 认证
    ├── middleware.py (34 行)           # 安全中间件
    ├── rate_limiter.py (54 行)         # 速率限制
    ├── validators.py (131 行)          # 输入验证
    ├── logger.py (89 行)               # 安全日志
    └── api_monitoring.py (200 行)      # API 监控
```

#### A.2 工具脚本

```
scripts/
├── dev/
│   └── start.sh                        # 开发启动
├── service/
│   ├── install_service.sh              # 服务安装
│   ├── manage_service.sh               # 服务管理
│   └── verify_after_reboot.sh          # 重启验证
├── security/
│   ├── generate_token.py               # Token 生成
│   └── check_security.sh               # 安全检查
└── dev/
    └── generate_english_summaries.py   # 批量生成英文摘要
```

#### A.3 客户端工具

```
utils/
├── rss_client.py (382 行)              # Python 客户端
├── regenerate_summaries.py (139 行)    # 摘要重新生成
└── example_usage.py                    # 使用示例
```

### B. 数据库表结构

#### B.1 feed 表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PRIMARY KEY | 自增主键 |
| name | VARCHAR(200) | NOT NULL | Feed 名称 |
| url | VARCHAR(2048) | UNIQUE NOT NULL | Feed URL |
| category | VARCHAR(50) | DEFAULT 'tech' | 分类 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否活跃 |
| created_at | DATETIME | | 创建时间 |
| updated_at | DATETIME | | 更新时间 |

**索引**:
- idx_feed_name
- idx_feed_category

#### B.2 article 表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PRIMARY KEY | 自增主键 |
| title | VARCHAR | NOT NULL | 文章标题 |
| link | VARCHAR(2048) | UNIQUE NOT NULL | 文章链接 |
| content | TEXT | | 文章内容 |
| summary | VARCHAR(100) | | 中文摘要 |
| summary_en | VARCHAR(200) | | 英文摘要 |
| published_at | DATETIME | | 发布时间 |
| feed_id | INTEGER | FOREIGN KEY | Feed ID |
| created_at | DATETIME | | 创建时间 |

**索引**:
- idx_article_title
- idx_article_published_at
- idx_article_feed_id

#### B.3 api_request_log 表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PRIMARY KEY | 自增主键 |
| request_id | VARCHAR(36) | | 请求 ID (UUID) |
| method | VARCHAR(10) | | HTTP 方法 |
| path | VARCHAR(255) | | 请求路径 |
| status_code | INTEGER | | 状态码 |
| response_time_ms | REAL | | 响应时间 |
| client_ip | VARCHAR(45) | | 客户端 IP |
| user_agent | TEXT | | User-Agent |
| error_msg | TEXT | | 错误信息 |
| created_at | DATETIME | | 创建时间 |

### C. API 端点速查表

| 端点 | 方法 | 认证 | 说明 |
|------|------|------|------|
| `/api/health` | GET | ❌ | 健康检查 |
| `/api/status` | GET | ❌ | 系统状态 |
| `/api/stats` | GET | ❌ | API 统计 |
| `/api/feeds` | GET | ❌ | 获取所有 Feed |
| `/api/feeds` | POST | ✅ | 添加新 Feed |
| `/api/feeds/{id}` | PUT | ✅ | 更新 Feed |
| `/api/feeds/{id}` | DELETE | ✅ | 删除 Feed |
| `/api/feeds/fetch` | POST | ✅ | 手动抓取 |
| `/api/articles` | GET | ❌ | 获取文章列表 |
| `/api/articles/{id}` | GET | ❌ | 获取单篇文章 |
| `/api/rss` | GET | ❌ | RSS 订阅（中文） |
| `/api/rss/en` | GET | ❌ | RSS 订阅（英文） |
| `/api/rss/bilingual` | GET | ❌ | RSS 订阅（双语） |
| `/api/rss/category/{category}` | GET | ❌ | 分类订阅 |

### D. 环境变量参考

| 变量名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `OPENAI_API_KEY` | string | 必填 | LLM API 密钥 |
| `API_TOKEN` | string | 必填 | 管理 Token |
| `OPENAI_API_BASE` | string | https://api.openai.com/v1 | API 基础 URL |
| `OPENAI_MODEL` | string | gpt-3.5-turbo | 使用的模型 |
| `FETCH_INTERVAL_HOURS` | integer | 1 | 抓取间隔（小时） |
| `SUMMARY_MAX_LENGTH` | integer | 100 | 摘要最大长度 |
| `LLM_TIMEOUT` | integer | 30 | LLM 超时（秒） |
| `MAX_CONCURRENT_SUMMARIES` | integer | 2 | 最大并发摘要数 |
| `CORS_ORIGINS` | string | http://localhost:3000 | CORS 允许源 |
| `RATE_LIMIT_ENABLED` | boolean | true | 是否启用速率限制 |
| `RATE_LIMIT_TIMES` | integer | 60 | 速率限制次数 |
| `RATE_LIMIT_SECONDS` | integer | 60 | 速率限制窗口 |
| `DATABASE_URL` | string | sqlite:///ai_rss_hub.db | 数据库 URL |

### E. 参考资源

#### E.1 官方文档

- [FastAPI 文档](https://fastapi.tiangolo.com/)
- [SQLModel 文档](https://sqlmodel.tiangolo.com/)
- [OpenAI API 文档](https://platform.openai.com/docs)
- [APScheduler 文档](https://apscheduler.readthedocs.io/)

#### E.2 相关标准

- [RSS 2.0 规范](https://www.rssboard.org/rss-specification)
- [RESTful API 设计指南](https://restfulapi.net/)
- [OpenAPI 规范](https://swagger.io/specification/)

#### E.3 项目文档

- [README.md](README.md) - 项目主文档
- [API 文档](docs/api/README.md) - API 完整文档
- [部署指南](docs/deployment/AUTO_START_GUIDE.md) - 生产部署
- [安全指南](config/env/.env.security) - 安全最佳实践

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|---------|
| 1.0 | 2026-01-09 | 初始版本，完整功能说明书 |

---

## 联系方式

- **GitHub**: https://github.com/goodniuniu/AI-RSS-Hub
- **Issues**: https://github.com/goodniuniu/AI-RSS-Hub/issues

---

**© 2026 AI-RSS-Hub. 本文档受 MIT 许可证保护。**
